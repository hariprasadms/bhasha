<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bhasha ‚Äî English to Indian Languages</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Noto+Sans+Kannada:wght@400;600&family=Noto+Sans+Telugu:wght@400;600&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --saffron: #E8561A;
      --saffron-light: #FF7A45;
      --bg: #1C1624;
      --surface: #261E32;
      --card: #302540;
      --card-hover: #38294A;
      --border: rgba(255,255,255,0.11);
      --border-strong: rgba(255,255,255,0.2);
      --text: #F0E8FF;
      --text-muted: rgba(240,232,255,0.55);
      --text-dim: rgba(240,232,255,0.35);
      --gold: #F0B429;
      --teal: #0EC4A8;
      --red: #FF4560;
    }
    body { background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; min-height:100vh; overflow-x:hidden; }
    /* Subtle warm glow top-left, cool glow bottom-right */
    body::before { content:''; position:fixed; top:-150px; left:-150px; width:500px; height:500px; background:radial-gradient(circle,rgba(232,86,26,.18),transparent 68%); pointer-events:none; z-index:0; }
    body::after  { content:''; position:fixed; bottom:-150px; right:-150px; width:500px; height:500px; background:radial-gradient(circle,rgba(14,196,168,.13),transparent 68%); pointer-events:none; z-index:0; }
    .page { max-width:920px; margin:0 auto; padding:2rem 1.5rem 5rem; position:relative; z-index:1; }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header { text-align:center; padding:2rem 0 2.2rem; }
    .logo-row { display:flex; align-items:center; justify-content:center; gap:.8rem; margin-bottom:.5rem; }
    .dot { width:9px; height:9px; background:var(--saffron-light); border-radius:50%; animation:pulse 2.2s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(1.5)} }
    h1 { font-family:'Playfair Display',serif; font-size:clamp(2.1rem,6vw,3.4rem); font-weight:900; background:linear-gradient(135deg,#fff 0%,var(--gold) 55%,var(--saffron-light) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .tagline { color:var(--text-muted); font-size:.88rem; letter-spacing:.1em; text-transform:uppercase; margin-top:.5rem; font-weight:400; }
    .badge-row { display:flex; gap:.5rem; justify-content:center; margin-top:1rem; flex-wrap:wrap; }
    .badge { background:rgba(232,86,26,.15); border:1px solid rgba(232,86,26,.35); color:var(--saffron-light); padding:.28rem .85rem; border-radius:999px; font-size:.78rem; font-weight:500; }

    /* ‚îÄ‚îÄ Section label ‚îÄ‚îÄ */
    .sec-label { font-size:.68rem; font-weight:600; letter-spacing:.12em; text-transform:uppercase; color:var(--text-dim); margin-bottom:.65rem; display:block; }

    /* ‚îÄ‚îÄ Language selector ‚îÄ‚îÄ */
    .lang-sel { display:flex; gap:.75rem; margin-bottom:1.4rem; }
    .lang-btn { flex:1; padding:.9rem 1rem; background:var(--surface); border:2px solid var(--border); border-radius:14px; color:var(--text-muted); font-family:'DM Sans',sans-serif; font-size:.92rem; font-weight:500; cursor:pointer; transition:all .22s; display:flex; flex-direction:column; align-items:center; gap:.3rem; }
    .lang-btn .native { font-size:1.15rem; font-weight:600; color:var(--text-dim); transition:color .22s; }
    .lang-btn:hover { border-color:var(--border-strong); color:var(--text); background:var(--card); }
    .lang-btn.on { border-color:var(--saffron-light); background:rgba(232,86,26,.12); color:var(--text); }
    .lang-btn.on .native { color:var(--gold); }
    #btn-kn .native { font-family:'Noto Sans Kannada',sans-serif; }
    #btn-te .native { font-family:'Noto Sans Telugu',sans-serif; }

    /* ‚îÄ‚îÄ Tone ‚îÄ‚îÄ */
    .tone-section { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:1.1rem 1.2rem; margin-bottom:1.2rem; }
    .tone-grid { display:flex; flex-wrap:wrap; gap:.45rem; }
    .tone-btn { padding:.4rem .9rem; background:var(--card); border:1.5px solid var(--border); border-radius:999px; color:var(--text-muted); font-family:'DM Sans',sans-serif; font-size:.8rem; font-weight:500; cursor:pointer; transition:all .18s; user-select:none; }
    .tone-btn:hover { border-color:var(--border-strong); color:var(--text); background:var(--card-hover); }
    .tone-btn.on { border-color:var(--gold); background:rgba(240,180,41,.14); color:var(--gold); }
    .tone-desc { display:none; margin-top:.65rem; padding:.4rem .85rem; background:rgba(240,180,41,.08); border:1px solid rgba(240,180,41,.22); border-radius:8px; font-size:.76rem; color:rgba(240,180,41,.9); font-style:italic; }
    .tone-desc.show { display:block; }

    /* ‚îÄ‚îÄ API Key notice ‚îÄ‚îÄ */
    .api-notice { background:rgba(240,180,41,.07); border:1px solid rgba(240,180,41,.25); border-radius:14px; padding:1rem 1.15rem; margin-bottom:1.2rem; font-size:.82rem; color:rgba(240,180,41,.9); display:none; }
    .api-notice.show { display:block; }
    .api-notice a { color:var(--gold); text-decoration:underline; }
    .api-notice-title { font-size:.9rem; font-weight:600; color:var(--gold); margin-bottom:.4rem; display:flex; align-items:center; gap:.4rem; }
    .api-notice-sub { line-height:1.6; }
    .api-key-row { display:flex; gap:.5rem; margin-top:.7rem; }
    .api-key-input { flex:1; background:rgba(255,255,255,.07); border:1px solid rgba(240,180,41,.3); border-radius:9px; padding:.48rem .85rem; color:var(--text); font-family:'DM Sans',sans-serif; font-size:.82rem; outline:none; transition:border-color .2s; }
    .api-key-input:focus { border-color:rgba(240,180,41,.65); }
    .api-key-input::placeholder { color:var(--text-dim); }
    .api-key-save { padding:.48rem 1.1rem; background:rgba(240,180,41,.2); border:1px solid rgba(240,180,41,.4); border-radius:9px; color:var(--gold); font-family:'DM Sans',sans-serif; font-size:.8rem; font-weight:600; cursor:pointer; transition:all .2s; white-space:nowrap; }
    .api-key-save:hover { background:rgba(240,180,41,.3); }
    .security-badges { display:flex; flex-wrap:wrap; gap:.45rem; margin-top:.85rem; padding-top:.8rem; border-top:1px solid rgba(240,180,41,.14); }
    .sec-badge { display:flex; align-items:center; gap:.32rem; padding:.3rem .75rem; border-radius:999px; font-size:.71rem; font-weight:500; }
    .sec-badge.green { background:rgba(14,196,168,.13); border:1px solid rgba(14,196,168,.32); color:var(--teal); }
    .sec-badge.blue  { background:rgba(120,170,255,.1); border:1px solid rgba(120,170,255,.28); color:#9ec5ff; }
    .sec-badge.grey  { background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); color:var(--text-muted); }

    /* ‚îÄ‚îÄ Translation panel ‚îÄ‚îÄ */
    .panel { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin:1.2rem 0; }
    .box { background:var(--surface); border:1.5px solid var(--border); border-radius:18px; padding:1.25rem; display:flex; flex-direction:column; gap:.7rem; transition:border-color .25s, box-shadow .25s; }
    .box:focus-within { border-color:rgba(232,86,26,.5); box-shadow:0 0 0 3px rgba(232,86,26,.08); }
    .box-top { display:flex; align-items:center; justify-content:space-between; }
    .box-label { font-size:.68rem; font-weight:600; letter-spacing:.12em; text-transform:uppercase; color:var(--text-dim); }
    .tone-tag { font-size:.66rem; padding:.2rem .6rem; background:rgba(240,180,41,.13); border:1px solid rgba(240,180,41,.3); border-radius:999px; color:var(--gold); display:none; font-weight:500; }
    .tone-tag.show { display:inline-block; }
    textarea { background:transparent; border:none; outline:none; color:var(--text); font-family:'DM Sans',sans-serif; font-size:1rem; font-weight:400; line-height:1.75; resize:none; flex:1; min-height:160px; }
    textarea::placeholder { color:var(--text-dim); }
    .char-c { font-size:.71rem; color:var(--text-dim); }
    #output { min-height:160px; line-height:1.85; font-size:1.05rem; white-space:pre-wrap; word-break:break-word; color:var(--text-dim); font-style:italic; }
    #output.kn { font-family:'Noto Sans Kannada',sans-serif; color:var(--text); font-style:normal; font-size:1.1rem; }
    #output.te { font-family:'Noto Sans Telugu',sans-serif; color:var(--text); font-style:normal; font-size:1.1rem; }

    /* ‚îÄ‚îÄ Actions ‚îÄ‚îÄ */
    .actions { display:flex; gap:.75rem; align-items:center; }
    .btn-main { flex:1; padding:1rem 2rem; background:linear-gradient(135deg,var(--saffron-light),var(--saffron)); border:none; border-radius:13px; color:#fff; font-family:'DM Sans',sans-serif; font-size:1rem; font-weight:600; cursor:pointer; transition:all .22s; display:flex; align-items:center; justify-content:center; gap:.5rem; letter-spacing:.02em; }
    .btn-main:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 10px 28px rgba(232,86,26,.38); }
    .btn-main:disabled { opacity:.4; cursor:not-allowed; }
    .btn-icon { width:44px; height:44px; background:var(--surface); border:1.5px solid var(--border); border-radius:10px; color:var(--text-muted); font-size:1.1rem; cursor:pointer; transition:all .2s; display:flex; align-items:center; justify-content:center; }
    .btn-icon:hover { background:var(--card); border-color:var(--border-strong); color:var(--text); }

    /* ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ */
    .status { min-height:28px; text-align:center; font-size:.82rem; padding:.35rem; margin-top:.3rem; color:var(--text-dim); font-weight:400; }
    .status.loading { color:var(--gold); }
    .status.error   { color:var(--red); }
    .status.success { color:var(--teal); }
    .spinner { display:inline-block; width:12px; height:12px; border:2px solid rgba(240,180,41,.3); border-top-color:var(--gold); border-radius:50%; animation:spin .75s linear infinite; vertical-align:middle; margin-right:6px; }
    @keyframes spin { to{transform:rotate(360deg)} }

    /* ‚îÄ‚îÄ Step indicator ‚îÄ‚îÄ */
    .steps { display:none; align-items:center; justify-content:center; gap:.5rem; font-size:.74rem; padding:.3rem 0; color:var(--text-dim); flex-wrap:wrap; }
    .steps.show { display:flex; }
    .step { padding:.22rem .7rem; border-radius:999px; background:var(--surface); border:1px solid var(--border); transition:all .3s; font-weight:500; }
    .step.active { background:rgba(240,180,41,.13); border-color:rgba(240,180,41,.35); color:var(--gold); }
    .step.done   { background:rgba(14,196,168,.12); border-color:rgba(14,196,168,.35); color:var(--teal); }
    .arr { opacity:.3; font-size:.85rem; }

    /* ‚îÄ‚îÄ Example chips ‚îÄ‚îÄ */
    .examples { margin-top:2rem; }
    .chips { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.65rem; }
    .chip { background:var(--surface); border:1.5px solid var(--border); border-radius:999px; padding:.35rem .9rem; font-size:.8rem; color:var(--text-muted); cursor:pointer; transition:all .18s; user-select:none; font-weight:400; }
    .chip:hover { background:rgba(232,86,26,.12); border-color:rgba(232,86,26,.45); color:var(--text); }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast { position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(80px); background:var(--teal); color:#fff; padding:.6rem 1.5rem; border-radius:999px; font-size:.84rem; font-weight:600; transition:transform .3s; z-index:100; pointer-events:none; }
    .toast.show { transform:translateX(-50%) translateY(0); }
    footer { text-align:center; margin-top:3rem; color:var(--text-dim); font-size:.72rem; }



    /* ‚îÄ‚îÄ Text-to-Speech buttons ‚îÄ‚îÄ */
    .speak-btn {
      width:33px; height:33px; border-radius:50%;
      background:var(--card); border:1.5px solid var(--border);
      color:var(--text-muted); font-size:.88rem;
      cursor:pointer; transition:all .22s; display:flex; align-items:center; justify-content:center;
      flex-shrink:0;
    }
    .speak-btn:hover { background:rgba(14,196,168,.15); border-color:rgba(14,196,168,.45); color:var(--teal); }
    .speak-btn.speaking {
      background:rgba(14,196,168,.2); border-color:var(--teal);
      color:var(--teal); animation:tts-pulse 1.2s ease-in-out infinite;
    }
    .speak-btn:disabled, .speak-btn.no-text { opacity:.22; cursor:not-allowed; }
    @keyframes tts-pulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(14,196,168,.5); }
      50%      { box-shadow: 0 0 0 7px rgba(14,196,168,0); }
    }
    .output-toolbar { display:flex; align-items:center; justify-content:space-between; margin-top:.3rem; }
    .tts-warn { font-size:.71rem; color:rgba(255,100,80,.8); margin-top:.3rem; display:none; background:rgba(255,70,86,.08); border:1px solid rgba(255,70,86,.2); padding:.3rem .65rem; border-radius:7px; }
    .tts-warn.show { display:block; }

    /* ‚îÄ‚îÄ Voice input ‚îÄ‚îÄ */
    .input-toolbar { display:flex; align-items:center; justify-content:space-between; }
    .mic-btn {
      width:36px; height:36px; border-radius:50%;
      background:var(--card); border:1.5px solid var(--border);
      color:var(--text-muted); font-size:.95rem;
      cursor:pointer; transition:all .22s; display:flex; align-items:center; justify-content:center;
      flex-shrink:0;
    }
    .mic-btn:hover { background:rgba(232,86,26,.15); border-color:rgba(232,86,26,.5); color:var(--saffron-light); }
    .mic-btn.listening {
      background:rgba(255,60,60,.18); border-color:rgba(255,70,86,.7);
      color:var(--red); animation:mic-pulse 1s ease-in-out infinite;
    }
    .mic-btn.unsupported { opacity:.28; cursor:not-allowed; }
    @keyframes mic-pulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(255,70,86,.45); }
      50%      { box-shadow: 0 0 0 9px rgba(255,70,86,0); }
    }
    .voice-status {
      font-size:.73rem; color:var(--red); margin-top:.38rem;
      display:none; align-items:center; gap:.45rem;
    }
    .voice-status.show { display:flex; }
    .voice-dot { width:7px; height:7px; background:var(--red); border-radius:50%; animation:blink .75s infinite; flex-shrink:0; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.15} }
    .browser-warn { font-size:.72rem; color:rgba(255,140,80,.9); margin-top:.3rem; display:none; background:rgba(232,86,26,.09); border:1px solid rgba(232,86,26,.2); padding:.3rem .65rem; border-radius:7px; }
    .browser-warn.show { display:block; }

    @media(max-width:580px) { .panel{grid-template-columns:1fr} .lang-sel{flex-direction:column} }
  </style>
</head>
<body>
<div class="page">

  <header>
    <div class="logo-row"><div class="dot"></div><h1>Bhasha</h1><div class="dot"></div></div>
    <p class="tagline">English ‚Üí Indian Language Translator</p>
    <div class="badge-row">
      <span class="badge">‡≤ï‡≤®‡≥ç‡≤®‡≤° Kannada</span>
      <span class="badge">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å Telugu</span>
    </div>
  </header>

  <!-- Language -->
  <div class="lang-sel">
    <button class="lang-btn on" id="btn-kn">
      <span>Kannada</span><span class="native">‡≤ï‡≤®‡≥ç‡≤®‡≤°</span>
    </button>
    <button class="lang-btn" id="btn-te">
      <span>Telugu</span><span class="native">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</span>
    </button>
  </div>

  <!-- Tone -->
  <div class="tone-section">
    <span class="sec-label">‚óÜ Tone / Style</span>
    <div class="tone-grid" id="toneGrid">
      <button class="tone-btn on"  data-tone="neutral"  data-desc="Standard translation, no tone change applied">‚ö™ Neutral</button>
      <button class="tone-btn"     data-tone="friendly" data-desc="Warm and casual ‚Äî like texting a close friend">üòä Friendly</button>
      <button class="tone-btn"     data-tone="formal"   data-desc="Professional and respectful ‚Äî for official use">üëî Formal</button>
      <button class="tone-btn"     data-tone="funny"    data-desc="Playful and humorous with light wit">üòÇ Funny</button>
      <button class="tone-btn"     data-tone="romantic" data-desc="Warm, affectionate and heartfelt">‚ù§Ô∏è Romantic</button>
      <button class="tone-btn"     data-tone="poetic"   data-desc="Lyrical, expressive and elegant">‚ú® Poetic</button>
      <button class="tone-btn"     data-tone="blunt"    data-desc="Harsh and direct ‚Äî no softening, no filters">üò§ Blunt</button>
      <button class="tone-btn"     data-tone="simple"   data-desc="Very easy words ‚Äî anyone can understand">üë¶ Simple</button>
    </div>
    <div class="tone-desc" id="toneDesc"></div>
  </div>

  <!-- API Key notice (shown when non-neutral tone selected) -->
  <div class="api-notice" id="apiNotice">
    <div class="api-notice-title">‚ö° API Key Required for Tone Feature</div>
    <div class="api-notice-sub">
      Get a free key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> ‚Äî free tier is enough for hundreds of requests per day.
    </div>
    <div class="api-key-row">
      <input class="api-key-input" id="apiKeyInput" type="password" placeholder="Paste your API key: sk-ant-..."/>
      <button class="api-key-save" id="apiKeySave">Save Key</button>
    </div>
    <!-- Security assurance badges -->
    <div class="security-badges">
      <span class="sec-badge green">üîí Stored only in your browser (localStorage)</span>
      <span class="sec-badge blue">üö´ Never sent to any server</span>
      <span class="sec-badge grey">üëÅ Only used to call Anthropic API directly</span>
      <span class="sec-badge green">üóë Clear anytime ‚Äî just delete and save</span>
    </div>
  </div>

  <!-- Translation Panel -->
  <div class="panel">
    <div class="box">
      <div class="box-top">
        <span class="box-label">English</span>
        <span class="tone-tag" id="toneTag"></span>
      </div>
      <textarea id="inputText" placeholder="Type, paste, or üé§ speak English here..." maxlength="500"></textarea>
      <div class="voice-status" id="voiceStatus">
        <span class="voice-dot"></span> Listening... speak now
      </div>
      <div class="browser-warn" id="browserWarn">
        ‚ö†Ô∏è Voice input requires Chrome or Edge browser
      </div>
      <div class="input-toolbar">
        <div class="char-c" id="charCount">0 / 500</div>
        <div style="display:flex;gap:.4rem;align-items:center;">
          <button class="speak-btn no-text" id="speakEnBtn" title="Listen to English text">üîä</button>
          <button class="mic-btn" id="micBtn" title="Click to speak">üé§</button>
        </div>
      </div>
    </div>
    <div class="box">
      <div class="box-top">
        <span class="box-label" id="outputLabel">Kannada</span>
        <button class="speak-btn no-text" id="speakOutBtn" title="Listen to translation">üîä</button>
      </div>
      <div id="output">Translation will appear here...</div>
      <div class="tts-warn" id="ttsWarn"></div>
    </div>
  </div>

  <!-- Actions -->
  <div class="actions">
    <button class="btn-main" id="translateBtn" disabled>‚ú¶ Translate</button>
    <button class="btn-icon" id="clearBtn" title="Clear">‚úï</button>
    <button class="btn-icon" id="copyBtn" title="Copy">‚éò</button>
  </div>

  <!-- Step indicator -->
  <div class="steps" id="steps">
    <span class="step" id="s1">1. Applying tone</span>
    <span class="arr">‚Ä∫</span>
    <span class="step" id="s2">2. Translating</span>
    <span class="arr">‚Ä∫</span>
    <span class="step" id="s3">3. Done</span>
  </div>

  <div class="status" id="status"></div>

  <!-- Examples -->
  <div class="examples">
    <span class="sec-label">‚óÜ Try an example</span>
    <div class="chips" id="chips">
      <span class="chip">Hello, how are you?</span>
      <span class="chip">What is your name?</span>
      <span class="chip">I love India</span>
      <span class="chip">Good morning</span>
      <span class="chip">Thank you very much</span>
      <span class="chip">Where is the railway station?</span>
      <span class="chip">Please speak slowly</span>
    </div>
  </div>

  <footer>Powered by Claude AI (tone) ¬∑ MyMemory / Google Translate ¬∑ v2.0</footer>
</div>

<div class="toast" id="toast">Copied!</div>

<script>
(function () {
  'use strict';

  /* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
  var lang      = 'kn';
  var tone      = 'neutral';
  var running   = false;
  var savedKey  = localStorage.getItem('bhasha_api_key') || '';

  var TONE_PROMPTS = {
    friendly: 'Rewrite this text in a warm, casual and friendly tone like texting a close friend. Keep the exact same meaning. Reply with ONLY the rewritten text, nothing else.',
    formal:   'Rewrite this text in a formal, professional and respectful tone for official communication. Keep the exact same meaning. Reply with ONLY the rewritten text, nothing else.',
    funny:    'Rewrite this text in a funny, playful and humorous tone with light wit. Keep the core meaning. Reply with ONLY the rewritten text, nothing else.',
    romantic: 'Rewrite this text in a romantic, warm and affectionate tone. Keep the exact same meaning. Reply with ONLY the rewritten text, nothing else.',
    poetic:   'Rewrite this text in a poetic, lyrical and expressive style. Keep the meaning. Reply with ONLY the rewritten text, nothing else.',
    blunt:    'Rewrite this text in a blunt, harsh and direct tone with no politeness. Keep the same meaning. Reply with ONLY the rewritten text, nothing else.',
    simple:   'Rewrite this text using very simple, short words so a young child can understand. Keep the meaning. Reply with ONLY the rewritten text, nothing else.'
  };

  var LANG_CFG = {
    kn: { label: 'Kannada', cls: 'kn' },
    te: { label: 'Telugu',  cls: 'te' }
  };

  /* ‚îÄ‚îÄ DOM ‚îÄ‚îÄ */
  var inputEl      = document.getElementById('inputText');
  var outputEl     = document.getElementById('output');
  var outputLabel  = document.getElementById('outputLabel');
  var charCount    = document.getElementById('charCount');
  var statusEl     = document.getElementById('status');
  var translateBtn = document.getElementById('translateBtn');
  var clearBtn     = document.getElementById('clearBtn');
  var copyBtn      = document.getElementById('copyBtn');
  var toastEl      = document.getElementById('toast');
  var toneTag      = document.getElementById('toneTag');
  var toneDesc     = document.getElementById('toneDesc');
  var stepsEl      = document.getElementById('steps');
  var apiNotice    = document.getElementById('apiNotice');
  var apiKeyInput  = document.getElementById('apiKeyInput');
  var apiKeySave   = document.getElementById('apiKeySave');

  /* pre-fill saved key */
  if (savedKey) apiKeyInput.value = savedKey;

  /* ‚îÄ‚îÄ API key save ‚îÄ‚îÄ */
  apiKeySave.addEventListener('click', function () {
    savedKey = apiKeyInput.value.trim();
    localStorage.setItem('bhasha_api_key', savedKey);
    apiKeySave.textContent = 'Saved ‚úì';
    setTimeout(function () { apiKeySave.textContent = 'Save'; }, 1500);
  });

  /* ‚îÄ‚îÄ Language ‚îÄ‚îÄ */
  document.getElementById('btn-kn').addEventListener('click', function () { setLang('kn'); });
  document.getElementById('btn-te').addEventListener('click', function () { setLang('te'); });
  function setLang(l) {
    lang = l;
    document.getElementById('btn-kn').classList.toggle('on', l === 'kn');
    document.getElementById('btn-te').classList.toggle('on', l === 'te');
    outputLabel.textContent = LANG_CFG[l].label;
    resetOutput();
  }

  /* ‚îÄ‚îÄ Tone ‚îÄ‚îÄ */
  document.getElementById('toneGrid').addEventListener('click', function (e) {
    var btn = e.target.closest('.tone-btn');
    if (!btn) return;
    document.querySelectorAll('.tone-btn').forEach(function (b) { b.classList.remove('on'); });
    btn.classList.add('on');
    tone = btn.dataset.tone;

    if (tone === 'neutral') {
      toneTag.className = 'tone-tag';
      toneDesc.className = 'tone-desc';
      apiNotice.className = 'api-notice';
      stepsEl.className = 'steps';
    } else {
      toneTag.textContent = btn.textContent.trim();
      toneTag.className = 'tone-tag show';
      toneDesc.textContent = btn.dataset.desc;
      toneDesc.className = 'tone-desc show';
      apiNotice.className = 'api-notice show';
    }
  });

  /* ‚îÄ‚îÄ Input ‚îÄ‚îÄ */
  inputEl.addEventListener('input', function () {
    charCount.textContent = inputEl.value.length + ' / 500';
    translateBtn.disabled = inputEl.value.trim() === '' || running;
  });

  inputEl.addEventListener('keydown', function (e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !translateBtn.disabled) go();
  });

  /* ‚îÄ‚îÄ Example chips ‚îÄ‚îÄ */
  document.getElementById('chips').addEventListener('click', function (e) {
    if (!e.target.classList.contains('chip')) return;
    inputEl.value = e.target.textContent.trim();
    charCount.textContent = inputEl.value.length + ' / 500';
    translateBtn.disabled = false;
    inputEl.focus();
  });

  /* ‚îÄ‚îÄ Clear ‚îÄ‚îÄ */
  clearBtn.addEventListener('click', function () {
    inputEl.value = '';
    charCount.textContent = '0 / 500';
    translateBtn.disabled = true;
    resetOutput();
    setStatus('', '');
    stepsEl.className = 'steps';
  });

  /* ‚îÄ‚îÄ Copy ‚îÄ‚îÄ */
  copyBtn.addEventListener('click', function () {
    var txt = outputEl.textContent;
    if (!txt || txt === 'Translation will appear here...') return;
    navigator.clipboard.writeText(txt).then(function () {
      toastEl.classList.add('show');
      setTimeout(function () { toastEl.classList.remove('show'); }, 2000);
    });
  });

  /* ‚îÄ‚îÄ Translate ‚îÄ‚îÄ */
  translateBtn.addEventListener('click', go);

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PIPELINE
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  function go() {
    var text = inputEl.value.trim();
    if (!text || running) return;

    running = true;
    translateBtn.disabled = true;
    translateBtn.innerHTML = '<span class="spinner"></span> Translating...';
    outputEl.className = '';
    outputEl.textContent = '';

    var code = lang;

    if (tone !== 'neutral') {
      stepsEl.className = 'steps show';
      setStep('s1');
      setStatus('<span class="spinner"></span> Applying ' + tone + ' tone with AI...', 'loading');

      applyTone(text, tone)
        .then(function (toned) {
          setStep('s2');
          setStatus('<span class="spinner"></span> Translating to ' + LANG_CFG[code].label + '...', 'loading');
          return runTranslation(toned, code);
        })
        .then(function (result) {
          setStep('s3');
          onDone(result);
        })
        .catch(function (err) {
          /* if tone AI failed, fallback to direct translation */
          if (err.isToneError) {
            setStep('s2');
            setStatus('<span class="spinner"></span> AI unavailable ‚Äî translating directly...', 'loading');
            runTranslation(text, code)
              .then(function (r) { setStep('s3'); onDone(r); })
              .catch(function (e) { onError(e.message); });
          } else {
            onError(err.message);
          }
        });

    } else {
      stepsEl.className = 'steps';
      setStatus('<span class="spinner"></span> Translating...', 'loading');
      runTranslation(text, code)
        .then(onDone)
        .catch(function (e) { onError(e.message); });
    }
  }

  /* ‚îÄ‚îÄ Claude tone rewriter ‚îÄ‚îÄ */
  function applyTone(text, t) {
    var key = savedKey || apiKeyInput.value.trim();
    if (!key) {
      var err = new Error('No API key. Please add your Anthropic API key above.');
      err.isToneError = true;
      return Promise.reject(err);
    }

    return fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 500,
        messages: [{ role: 'user', content: TONE_PROMPTS[t] + '\n\nText: ' + text }]
      })
    })
    .then(function (res) {
      if (!res.ok) {
        return res.json().then(function (e) {
          var err = new Error('Claude API: ' + (e.error && e.error.message || res.status));
          err.isToneError = true;
          throw err;
        });
      }
      return res.json();
    })
    .then(function (data) {
      var out = data && data.content && data.content[0] && data.content[0].text;
      if (!out) { var err = new Error('Empty AI response'); err.isToneError = true; throw err; }
      return out.trim();
    });
  }

  /* ‚îÄ‚îÄ Translation: MyMemory ‚Üí Google fallback ‚îÄ‚îÄ */
  function runTranslation(text, langCode) {
    return fetchMyMemory(text, langCode).catch(function (e1) {
      console.warn('MyMemory failed:', e1.message);
      return fetchGoogle(text, langCode);
    });
  }

  function fetchMyMemory(text, langCode) {
    return fetch('https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text) + '&langpair=en|' + langCode)
      .then(function (r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(function (j) {
        if (j.responseStatus !== 200) throw new Error('MyMemory: ' + j.responseStatus);
        var t = j.responseData && j.responseData.translatedText;
        if (!t || t.toLowerCase() === text.toLowerCase()) throw new Error('No translation');
        return t;
      });
  }

  function fetchGoogle(text, langCode) {
    return fetch('https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=' + langCode + '&dt=t&q=' + encodeURIComponent(text))
      .then(function (r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(function (j) {
        if (!j || !Array.isArray(j[0])) throw new Error('Bad response');
        var res = j[0].filter(function (s) { return s && s[0]; }).map(function (s) { return s[0]; }).join('');
        if (!res) throw new Error('Empty result');
        return res;
      });
  }

  /* ‚îÄ‚îÄ Result handlers ‚îÄ‚îÄ */
  function onDone(text) {
    if (!text || !text.trim()) { onError('Received empty translation.'); return; }
    outputEl.className = LANG_CFG[lang].cls;
    outputEl.textContent = text;
    var note = tone !== 'neutral' ? '  ¬∑  tone: ' + tone : '';
    setStatus('‚úì Translation complete' + note, 'success');
    resetBtn(); running = false;
  }

  function onError(msg) {
    resetOutput();
    setStatus('‚úï ' + (msg || 'Something went wrong.'), 'error');
    resetBtn(); running = false;
    stepsEl.className = 'steps';
  }

  function resetBtn() {
    translateBtn.disabled = inputEl.value.trim() === '';
    translateBtn.innerHTML = '‚ú¶ Translate';
  }

  /* ‚îÄ‚îÄ Step indicator ‚îÄ‚îÄ */
  function setStep(active) {
    var all = ['s1', 's2', 's3'];
    var ai  = all.indexOf(active);
    all.forEach(function (id, i) {
      var el = document.getElementById(id);
      if (i < ai)       el.className = 'step done';
      else if (i === ai) el.className = 'step active';
      else               el.className = 'step';
    });
  }

  /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
  function resetOutput() {
    outputEl.className = '';
    outputEl.textContent = 'Translation will appear here...';
    outputEl.style.color = 'rgba(255,248,239,.2)';
    outputEl.style.fontStyle = 'italic';
  }
  // override resetOutput so placeholder looks right
  outputEl.textContent = 'Translation will appear here...';

  function setStatus(html, type) {
    statusEl.innerHTML = html;
    statusEl.className = 'status' + (type ? ' ' + type : '');
  }


  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     VOICE INPUT (Web Speech API)
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  var micBtn       = document.getElementById('micBtn');
  var voiceStatus  = document.getElementById('voiceStatus');
  var browserWarn  = document.getElementById('browserWarn');
  var recognition  = null;
  var isListening  = false;

  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    /* Browser doesn't support it ‚Äî disable mic button gracefully */
    micBtn.classList.add('unsupported');
    micBtn.title = 'Voice input not supported in this browser. Use Chrome or Edge.';
    micBtn.addEventListener('click', function () {
      browserWarn.className = 'browser-warn show';
      setTimeout(function () { browserWarn.className = 'browser-warn'; }, 4000);
    });
  } else {
    /* Set up recognition */
    recognition = new SpeechRecognition();
    recognition.lang        = 'en-US';
    recognition.continuous  = false;   /* stop after first pause */
    recognition.interimResults = true; /* show words as they come in */

    recognition.onstart = function () {
      isListening = true;
      micBtn.classList.add('listening');
      micBtn.title   = 'Listening‚Ä¶ click to stop';
      micBtn.textContent = '‚èπ';
      voiceStatus.className = 'voice-status show';
      setStatus('üé§ Listening‚Ä¶ speak now', 'loading');
    };

    recognition.onresult = function (e) {
      var interim = '';
      var final   = '';
      for (var i = e.resultIndex; i < e.results.length; i++) {
        var t = e.results[i][0].transcript;
        if (e.results[i].isFinal) final += t;
        else interim += t;
      }
      /* Show interim text in textarea as live preview */
      if (interim) inputEl.value = interim;
      /* Final result: set it properly and enable translate */
      if (final) {
        var current = inputEl.value.replace(interim, '').trim();
        inputEl.value = (current ? current + ' ' : '') + final.trim();
        charCount.textContent = inputEl.value.length + ' / 500';
        translateBtn.disabled = inputEl.value.trim() === '' || running;
      }
    };

    recognition.onerror = function (e) {
      var msg = {
        'not-allowed':     'üé§ Microphone access denied. Please allow mic access in your browser.',
        'no-speech':       'üé§ No speech detected. Try again.',
        'audio-capture':   'üé§ No microphone found.',
        'network':         'üé§ Network error during voice recognition.',
      }[e.error] || ('üé§ Error: ' + e.error);
      setStatus(msg, 'error');
      stopListening();
    };

    recognition.onend = function () {
      stopListening();
      if (inputEl.value.trim()) {
        setStatus('‚úì Voice captured ‚Äî press Translate or keep speaking', 'success');
        charCount.textContent = inputEl.value.length + ' / 500';
        translateBtn.disabled = false;
      } else {
        setStatus('', '');
      }
    };

    micBtn.addEventListener('click', function () {
      if (isListening) {
        recognition.stop();
      } else {
        /* Clear previous text before new recording? No ‚Äî append instead */
        try {
          recognition.start();
        } catch (e) {
          /* already started */
        }
      }
    });
  }

  function stopListening() {
    isListening = false;
    micBtn.classList.remove('listening');
    micBtn.title       = 'Click to speak';
    micBtn.textContent = 'üé§';
    voiceStatus.className = 'voice-status';
  }


  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TEXT-TO-SPEECH
     English  ‚Üí browser Web Speech API (reliable everywhere)
     Kannada/Telugu ‚Üí Google Translate TTS endpoint (no key needed,
                      same as translation API we already use)
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  var speakEnBtn  = document.getElementById('speakEnBtn');
  var speakOutBtn = document.getElementById('speakOutBtn');
  var ttsWarn     = document.getElementById('ttsWarn');

  /* Google Translate TTS lang codes */
  var GTTS_LANG = { kn: 'kn', te: 'te' };

  /* currently playing Audio object (for translated TTS) */
  var currentAudio    = null;
  var currentSpeakBtn = null;

  /* ‚îÄ‚îÄ English TTS: use browser speechSynthesis (en-US always works) ‚îÄ‚îÄ */
  function speakEnglish(text, btn) {
    if (!text) return;

    /* Toggle off if already speaking */
    if (currentSpeakBtn === btn && window.speechSynthesis && window.speechSynthesis.speaking) {
      window.speechSynthesis.cancel();
      setSpeakState(btn, false);
      currentSpeakBtn = null;
      return;
    }

    /* Cancel any Indian-lang audio that might be playing */
    stopCurrentAudio();

    if (!window.speechSynthesis) {
      showTtsWarn('Text-to-speech is not supported in this browser.');
      return;
    }

    window.speechSynthesis.cancel();
    var utter = new SpeechSynthesisUtterance(text);
    utter.lang  = 'en-US';
    utter.rate  = 0.92;
    utter.pitch = 1;

    utter.onstart = function () { currentSpeakBtn = btn; setSpeakState(btn, true); };
    utter.onend   = function () { setSpeakState(btn, false); currentSpeakBtn = null; };
    utter.onerror = function () { setSpeakState(btn, false); currentSpeakBtn = null; };

    window.speechSynthesis.speak(utter);
  }

  /* ‚îÄ‚îÄ Indian-language TTS: Google Translate audio endpoint ‚îÄ‚îÄ */
  function speakIndian(text, langCode, btn) {
    if (!text || text === 'Translation will appear here...') return;

    /* Toggle off */
    if (currentSpeakBtn === btn && currentAudio && !currentAudio.paused) {
      stopCurrentAudio();
      setSpeakState(btn, false);
      currentSpeakBtn = null;
      return;
    }

    /* Cancel any english speech */
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    stopCurrentAudio();

    /* Split into chunks ‚â§200 chars (Google TTS URL limit) */
    var chunks = splitText(text, 200);
    setSpeakState(btn, true);
    currentSpeakBtn = btn;
    ttsWarn.className = 'tts-warn';

    playChunks(chunks, langCode, btn, 0);
  }

  function playChunks(chunks, langCode, btn, idx) {
    if (idx >= chunks.length) {
      setSpeakState(btn, false);
      currentSpeakBtn = null;
      return;
    }
    /* If user stopped mid-way */
    if (currentSpeakBtn !== btn) return;

    var chunk = chunks[idx];
    var url = 'https://translate.googleapis.com/translate_tts?ie=UTF-8&client=tw-ob'
            + '&tl=' + langCode
            + '&q='  + encodeURIComponent(chunk);

    var audio = new Audio(url);
    currentAudio = audio;

    audio.onended = function () {
      playChunks(chunks, langCode, btn, idx + 1);
    };
    audio.onerror = function () {
      setSpeakState(btn, false);
      currentSpeakBtn = null;
      currentAudio    = null;
      showTtsWarn('Could not load audio. Check your internet connection.');
    };
    audio.play().catch(function(e) {
      setSpeakState(btn, false);
      currentSpeakBtn = null;
      currentAudio    = null;
      showTtsWarn('Audio playback blocked. Click the üîä button again to try.');
    });
  }

  function stopCurrentAudio() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.src = '';
      currentAudio = null;
    }
  }

  /* Split text into chunks without breaking words */
  function splitText(text, maxLen) {
    var chunks = [];
    while (text.length > maxLen) {
      var idx = text.lastIndexOf(' ', maxLen);
      if (idx === -1) idx = maxLen;
      chunks.push(text.slice(0, idx).trim());
      text = text.slice(idx).trim();
    }
    if (text) chunks.push(text);
    return chunks;
  }

  function setSpeakState(btn, active) {
    if (active) {
      btn.classList.add('speaking');
      btn.title = 'Click to stop';
      btn.textContent = '‚èπ';
    } else {
      btn.classList.remove('speaking');
      btn.textContent = 'üîä';
      btn.title = btn === speakEnBtn ? 'Listen to English text' : 'Listen to translation';
    }
  }

  function showTtsWarn(msg) {
    ttsWarn.textContent = '‚ö†Ô∏è ' + msg;
    ttsWarn.className = 'tts-warn show';
  }

  /* ‚îÄ‚îÄ Button listeners ‚îÄ‚îÄ */
  speakEnBtn.addEventListener('click', function () {
    speakEnglish(inputEl.value.trim(), speakEnBtn);
  });

  speakOutBtn.addEventListener('click', function () {
    var text = outputEl.textContent.trim();
    if (!text || text === 'Translation will appear here...') return;
    speakIndian(text, GTTS_LANG[lang] || 'kn', speakOutBtn);
  });

  /* ‚îÄ‚îÄ Enable/disable speak buttons based on content ‚îÄ‚îÄ */
  function updateSpeakBtns() {
    var hasInput  = inputEl.value.trim() !== '';
    var hasOutput = outputEl.textContent.trim() !== ''
                 && outputEl.textContent !== 'Translation will appear here...';
    speakEnBtn.classList.toggle('no-text', !hasInput);
    speakEnBtn.disabled = !hasInput;
    speakOutBtn.classList.toggle('no-text', !hasOutput);
    speakOutBtn.disabled = !hasOutput;
  }

  inputEl.addEventListener('input', updateSpeakBtns);

  /* Patch onDone to enable output speak btn after translation */
  var _origOnDone = onDone;
  onDone = function(text) {
    _origOnDone(text);
    setTimeout(updateSpeakBtns, 50);
  };

  /* Stop audio on clear */
  clearBtn.addEventListener('click', function () {
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    stopCurrentAudio();
    if (currentSpeakBtn) { setSpeakState(currentSpeakBtn, false); currentSpeakBtn = null; }
    ttsWarn.className = 'tts-warn';
    updateSpeakBtns();
  });

  updateSpeakBtns();


})();
</script>
</body>
</html>
